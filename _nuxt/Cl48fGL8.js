const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./B4Omts1i.js","./gz39GK1Y.js","./entry.DCLXpZFm.css"])))=>i.map(i=>d[i]);
import{aZ as w}from"./gz39GK1Y.js";import{c as p,t as d,a as f,f as b}from"./D-fb6i29.js";import"./DVuPDguZ.js";import"./DQuG8v1N.js";import"./27O-R1NT.js";import"./C_MFf4oo.js";import"./Bnsz6crt.js";import"./C3n-aZiU.js";async function h(o,r="gzip"){let e;if(typeof Buffer<"u"){const i=Buffer.from(o,"base64");e=Uint8Array.from(i)}else if(typeof atob<"u")e=Uint8Array.from(atob(o),i=>i.charCodeAt(0));else throw new TypeError("No base64 decoding method available");const n=new Response(new Blob([e])).body?.pipeThrough(new DecompressionStream(r)),c=await new Response(n).text();return JSON.parse(c)}function l(o,r){const e=g(o),t={...r};for(const n in t)e[n]==="json"&&t[n]&&t[n]!=="undefined"&&(t[n]=JSON.parse(t[n])),e[n]==="boolean"&&t[n]!=="undefined"&&(t[n]=!!t[n]);for(const n in t)t[n]==="NULL"&&(t[n]=void 0);return t}function g(o){const r=o.match(/FROM\s+(\w+)/);return r?p[y(r[1])]?.fields||{}:{}}function y(o){return o.replace(/^_content_/,"")}let a;const u=new Map,s=new Map;function M(o){async function r(e){const t=String(e);return a||(s.has("_")||s.set("_",S()),a=await s.get("_"),s.delete("_")),u.has(t)||(s.has(t)||s.set(t,_(e)),await s.get(t),u.set(t,"loaded"),s.delete(t)),a}return{all:async(e,t)=>(await r(o),a.exec({sql:e,bind:t,rowMode:"object",returnValue:"resultRows"}).map(n=>l(e,n))),first:async(e,t)=>(await r(o),l(e,a.exec({sql:e,bind:t,rowMode:"object",returnValue:"resultRows"}).shift())),exec:async(e,t)=>{await r(o),await a.exec({sql:e,bind:t})}}}async function S(){if(!a){const o=await w(()=>import("./B4Omts1i.js"),__vite__mapDeps([0,1,2]),import.meta.url).then(e=>e.default);globalThis.sqlite3ApiConfig={silent:!0,debug:(...e)=>console.debug(...e),warn:(...e)=>{String(e[0]).includes("OPFS sqlite3_vfs")||console.warn(...e)},error:(...e)=>console.error(...e),log:(...e)=>console.log(...e)};const r=await o();a=new r.oo1.DB}return a}async function _(o){if(window.sessionStorage.getItem("previewToken"))return a;let r=null;const e=`checksum_${o}`,t=`collection_${o}`;let n="matched";try{a.exec({sql:`SELECT * FROM ${d.info} where id = '${e}'`,rowMode:"object",returnValue:"resultRows"}).shift()?.version!==f[String(o)]&&(n="mismatch")}catch{n="missing"}if(n!=="matched"){if(window.localStorage.getItem(`content_${e}`)===f[String(o)]&&(r=window.localStorage.getItem(`content_${t}`)),!r){r=await b(void 0,String(o));try{window.localStorage.setItem(`content_${e}`,f[String(o)]),window.localStorage.setItem(`content_${t}`,r)}catch(i){console.error("Database integrity check failed, rebuilding database",i)}}const c=await h(r);await a.exec({sql:`DROP TABLE IF EXISTS ${d[String(o)]}`}),n==="mismatch"&&await a.exec({sql:`DELETE FROM ${d.info} WHERE id = '${e}'`});for(const i of c)try{await a.exec(i)}catch(m){console.error("Error executing command",m)}}return a}export{M as loadDatabaseAdapter};
